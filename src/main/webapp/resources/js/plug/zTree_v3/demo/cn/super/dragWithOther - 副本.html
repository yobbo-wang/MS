<!DOCTYPE html>
<HTML>
<HEAD>
	<TITLE> ZTREE DEMO - drag with other DOM</TITLE>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="../../../css/demo.css" type="text/css">
	<link rel="stylesheet" href="../../../css/zTreeStyle/zTreeStyle.css" type="text/css">
	<script type="text/javascript" src="../../../js/jquery-1.4.4.min.js"></script>
	<script type="text/javascript" src="../../../js/jquery.ztree.core-3.5.js"></script>
	<!--<script type="text/javascript" src="../../../js/jquery.ztree.excheck-3.5.js"></script>-->
	<script type="text/javascript" src="../../../js/jquery.ztree.exedit-3.5.js"></script>
	<style type="text/css">
		.dom_line {margin:2px;border-bottom:1px gray dotted;height:1px}
		/*.domBtnDiv {display:block;padding:2px;border:1px gray dotted;background-color:powderblue}*/
		.categoryDiv {
			border: 1px #999999 solid;
			width: 200px; 
			height:150px;
			overflow:auto;
		}
		.categoryDiv li{
			font-size: 13px;
			padding:1px;
			border-width: 0px 0px 0px 0px;
			border-style: solid;
			border-color: #ddd;
			line-height: 25px;
			overflow:auto;
		}
		.categoryDiv li:hover{
			background:#99CCFF; 
		}
		.domBtn {cursor:pointer; display:block;color:#000000; height:22px; line-height:22px; padding:0px 0px 0px 2px;}
		.domBtn_Disabled {display:inline-block;cursor:default;padding:2px;margin:2px 10px;border:1px gray solid;background-color:#DFDFDF;color:#999999}
		.dom_tmp {position:absolute;font-size:12px;}
		.active {background-color: #93C3CF}
		.icon-delete{
			background: url("cancel.png") no-repeat 0px 0px;
			background-position: 0px 3px;
			display: inline-block;
			float:right;
			right: 8px;
			width: 16px; 
			height:20px;
		}
	</style>
	<SCRIPT type="text/javascript">
		<!--
		var MoveTest = {
			noSel: function() {
				try {
					window.getSelection ? window.getSelection().removeAllRanges() : document.selection.empty();
				} catch(e){}
			},
			dragTree2Dom: function(treeId, treeNodes) {
				return !treeNodes[0].isParent;
			},
			prevTree: function(treeId, treeNodes, targetNode) {
				return !targetNode.isParent && targetNode.parentTId == treeNodes[0].parentTId;
			},
			nextTree: function(treeId, treeNodes, targetNode) {
				return !targetNode.isParent && targetNode.parentTId == treeNodes[0].parentTId;
			},
			innerTree: function(treeId, treeNodes, targetNode) {
				return targetNode!=null && targetNode.isParent && targetNode.tId == treeNodes[0].parentTId;
			},
			dragMove: function(e, treeId, treeNodes) {
				var p = null, pId = 'dom_' + treeNodes[0].pId;
				if (e.target.id == pId) {
					p = $(e.target);
				} else {
					p = $(e.target).parent('#' + pId);
					if (!p.get(0)) {
						p = null;
					}
				}

				// $('.domBtnDiv .active').removeClass('active');
				// if (p) {
				// 	p.addClass('active');
				// }
			},
			dropTree2Dom: function(e, treeId, treeNodes, targetNode, moveType) {
				var domId =  e.target.id;
				if(!domId || e.target.className == 'domBtn'){
					domId = e.target.parentElement.id;
				}
				if(!domId){
					return;
				}
				if(domId.indexOf("dom_") != 0){
					return;
				}
				var zTree = $.fn.zTree.getZTreeObj("treeDemo");
				zTree.removeNode(treeNodes[0]);

				$("#" + domId).append("<li class='domBtn' id='" + treeNodes[0].id + "' pId='" + treeNodes[0].pId + "'   onMouseOut='cleRemoveBtn(event,this,\"" + treeNodes[0].id + "\")' onmouseover='addRemoveBtn(event,this,\"" + treeNodes[0].id + "\",\"" + treeNodes[0].pId + "\",\"" + treeNodes[0].name + "\")'>" + treeNodes[0].name + "</li>");
				// MoveTest.updateType();
			},
			dom2Tree: function(id,pId,name) {
				var zTree = $.fn.zTree.getZTreeObj("treeDemo");
				var parentNode = zTree.getNodeByParam("id", pId);
				$("#" + id).remove();
				var nodes = zTree.addNodes(parentNode, {id:id, pId:pId,name:name});
				zTree.selectNode(nodes[0]);
				// MoveTest.updateType();
			},
			updateType: function() {
				// var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
				// nodes = zTree.getNodes();
				// for (var i=0, l=nodes.length; i<l; i++) {
				// 	var num = nodes[i].children ? nodes[i].children.length : 0;
				// 	nodes[i].name = nodes[i].name.replace(/ \(.*\)/gi, "") + " (" + num + ")";
				// 	zTree.updateNode(nodes[i]);
				// }
			}
		};

		function focusKey(e) {
			if (key.hasClass("empty")) {
				key.removeClass("empty");
			}
		}
		function blurKey(e) {
			if (key.get(0).value === "") {
				key.addClass("empty");
			}
		}
		var lastValue = "", nodeList = [], fontCss = {};
		function clickRadio(e) {
			lastValue = "";
			searchNode(e);
		}
		function searchNode(e) {
			var zTree = $.fn.zTree.getZTreeObj("treeDemo");
			var value = $.trim(key.get(0).value);
			if (value === "") return;
			updateNodes(false);
			nodeList = zTree.getNodesByParamFuzzy("name", value);
			updateNodes(true);

		}
		function updateNodes(highlight) {
			var zTree = $.fn.zTree.getZTreeObj("treeDemo");
			for( var i=0, l=nodeList.length; i<l; i++) {
				nodeList[i].highlight = highlight;
				zTree.updateNode(nodeList[i]);
				expandNode(zTree,nodeList[i]);
			}
		}
		//展开节点
		function expandNode(zTree,node){
			var pNode = node.getParentNode();
			if(pNode){
				zTree.expandNode(pNode, true, false, false, false);
				//递归展开所有节点
				expandNode(zTree,pNode);
			}
		}

		function getFontCss(treeId, treeNode) {
			return (!!treeNode.highlight) ? {color:"#A60000", "font-weight":"bold"} : {color:"#333", "font-weight":"normal"};
		}
		function filter(node) {
			return !node.isParent && node.isFirstNode;
		}

		//当鼠标指针移动到元素上时触发
		function addRemoveBtn(e,obj,id,pId,name){
			if( !e ) e = window.event;  
		    var reltg = e.relatedTarget ? e.relatedTarget : e.fromElement;  
		    while( reltg && reltg != obj ) reltg = reltg.parentNode;  
		    if( reltg != obj ){  
		        var aObj = $("#"+id);
				var removeStr = "<i id='del_"+id+"' class='icon-delete' onclick='MoveTest.dom2Tree(\""+id+"\",\""+pId+"\",\""+name+"\")'></i>";
				aObj.append(removeStr);
		    }  
		}

		//当鼠标指针移出元素时触发。
		function cleRemoveBtn(e,obj,id){
			if( !e ) e = window.event;  
		    var reltg = e.relatedTarget ? e.relatedTarget : e.toElement;  
		    while( reltg && reltg != obj ) reltg = reltg.parentNode;  
		    if( reltg != obj ){  
		        $("#del_"+id).remove();  
		   	}  
		}

		var setting = {
			edit: {
				enable: true,
				showRemoveBtn: false,
				showRenameBtn: false,
				drag: {
					prev: MoveTest.prevTree,//拖拽到目标节点时，设置是否允许移动到目标节点前面的操作。
					next: MoveTest.nextTree,//拖拽到目标节点时，设置是否允许移动到目标节点后面的操作。
					inner: MoveTest.innerTree//拖拽到目标节点时，设置是否允许成为目标节点的子节点。
				}
			},
			data: {
				keep: {
					parent: true,
					leaf: true
				},
				simpleData: {
					enable: true
				}
			},
			callback: {
				beforeDrag: MoveTest.dragTree2Dom,//用于捕获节点被拖拽之前的事件回调函数，并且根据返回值确定是否允许开启拖拽操作
				onDrop: MoveTest.dropTree2Dom,//用于捕获节点拖拽操作结束的事件回调函数,如果设置了 setting.callback.beforeDrop 方法，且返回 false，将无法触发 onDrop 事件回调函数。
				onDragMove: MoveTest.dragMove//用于捕获节点被拖拽过程中移动的事件回调函数,主要用于捕获 zTree 节点拖拽到的 DOM，从而操作对应的 DOM。
				// onMouseUp: MoveTest.dom2Tree//用于捕获 zTree 上鼠标按键松开后的事件回调函数
			},
			view: {
				selectedMulti: false,
				fontCss: getFontCss
			}
		};

		//role（1：组长,2:副组长,3:成员）
		var data =[
			{ id:0, name:"XXX银行", open:true},
			{ id:1, pId:0, name:"北京分行", open:true, isParent:true},
			{ id:2, pId:0, name:"深圳分行", open:true, isParent:true},
			{ id:3, pId:0, name:"长沙分行", open:true, isParent:true},
			{ id:11, pId:1, name:"财务部", open:true, isParent:true},
			{ id:12, pId:1, name:"信贷部", open:true, isParent:true},
			{ id:13, pId:1, name:"科技中心", open:true, isParent:true},
			{ id:21, pId:2, name:"财务部", open:true, isParent:true},
			{ id:22, pId:2, name:"信贷部", open:true, isParent:true},
			{ id:23, pId:2, name:"科技中心", open:true, isParent:true},
			{ id:111, pId:11, name:"张三1", role:1},
			{ id:112, pId:11, name:"李四1"},
			{ id:113, pId:11, name:"王五1", role:2},
			{ id:121, pId:12, name:"张三2"},
			{ id:122, pId:12, name:"李四2", role:3},
			{ id:123, pId:12, name:"王五2"},
			{ id:221, pId:22, name:"张五", role:2}
		];

		// //组长
		// var groupLeader = [111];
		// //副组长
		// var deputyGroupLeader  = [112,221];
		// //成员
		// var member = [113,123];

		var key;
		$(document).ready(function(){
			var zNodes = [];
			for(var i = 0 ; i < data.length ; i++){
				if(!data[i].role){
					zNodes.push(data[i]);
					continue;
				}
				// var domText = "<li class='domBtn' id='" + data[i].id + "' pId='" + data[i].pId + "'>" + data[i].name + "<i class='icon-delete' onclick='MoveTest.dom2Tree(\""+data[i].id+"\",\""+data[i].pId+"\",\""+data[i].name+"\")'></i></li>";
				var domText = "<li class='domBtn' id='" + data[i].id + "' pId='" + data[i].pId + "'   onMouseOut='cleRemoveBtn(event,this,\"" + data[i].id + "\")' onmouseover='addRemoveBtn(event,this,\"" + data[i].id + "\",\"" + data[i].pId + "\",\"" + data[i].name + "\")'>" + data[i].name + "</li>";
				if(data[i].role == 1){//组长
					$("#dom_1").append(domText);
				}else if(data[i].role == 2){//副组长
					$("#dom_2").append(domText);
				}else if(data[i].role == 3){//成员
					$("#dom_3").append(domText);
				}
			}


			$.fn.zTree.init($("#treeDemo"), setting, zNodes);
			key = $("#key");
			key.bind("focus", focusKey)
			.bind("blur", blurKey)
			.bind("propertychange", searchNode)
			.bind("input", searchNode);
			// MoveTest.updateType();
			// MoveTest.bindDom();
		});

		
		//-->
	</SCRIPT>
	
</HEAD>

<BODY>
<div class="content_wrap">
	<div class="left">
		节点名称：<input type="text" id="key" value="" class="empty" />
		<ul id="treeDemo" class="ztree"></ul>
	</div>
	<div class="right">
		
				<!-- <div class="domBtnDiv"> -->
					<ul id="dom_1" class="categoryDiv">
						<!-- <span class="domBtn" domId="11">大树</span>
						<span class="domBtn" domId="12">小草</span>
						<span class="domBtn" domId="13">花朵</span> -->
					</ul>
					<div class="dom_line"></div>
					<ul id="dom_2" class="categoryDiv">
						<!-- <li class="domBtn" id="21" pId="2">老虎<i class="icon-delete" onclick="MoveTest.dom2Tree('21','2','老虎')"></i></li>
						<li class="domBtn" id="22" pId="2">狗熊<i class="icon-delete" onclick="MoveTest.dom2Tree('22','2','狗熊')"></i></li>
						<li class="domBtn" id="23" pId="2" onMouseOut="cleRemoveBtn(event,this,'23')" onmouseover="addRemoveBtn(event,this,'23','2','狮子')" >狮子</li> -->
					</ul>
					<div class="dom_line"></div>
					<ul id="dom_3" class="categoryDiv">
					</ul>
				<!-- </div> -->
	</div>
</div>
</BODY>
</HTML>