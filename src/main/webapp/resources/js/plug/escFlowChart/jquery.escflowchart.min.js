(function(){var EscFlowChart=function(ele,opt){$this=this;$this.$element=ele,$this.defaults={url:null,flowData:[],submitJson:{},isEdit:true,showMergeNode:0,dic:new Dictionary(),scrollWidth:ele[0].scrollWidth,scrollHeight:ele[0].scrollHeight,connector:"StateMachine",wayOfDisplay:1,rankDir:"LR",rankSep:50,edgeSep:40,point:null,isSave:true,colorIndex:0,instance:null,temp:null,currentNode:null,dataIndex:0,minWidth:0,minHeight:0},$this.options=$.extend({},$this.defaults,opt)};EscFlowChart.prototype={init:function(){var flowData=$this.options.flowData;for(var i=0;i<flowData.length;i++){if(flowData[i].type=="merge"){flowData[i].color=$this.getColor();if($this.options.showMergeNode==1){flowData[i].isShow=1}else if($this.options.showMergeNode==2){flowData[i].isShow=0}}$this.options.dic.Add(flowData[i].id,flowData[i])}$this.laout();$this.options.instance=jsPlumb.getInstance({Endpoint:["Dot",{radius:2}],HoverPaintStyle:{strokeStyle:"#1e8151",lineWidth:2},ConnectionOverlays:[["Arrow",{location:1,id:"arrow",length:14,foldback:0.8}],["Label",{label:"",id:"label",cssClass:"aLabel"}]],Container:$this.$element.attr("id")});$this.$element.contextMenu('viewPprocessMenu',{shadow:false,bindings:{'pmCreate':$this.pmCreate,'pmModify':function(t){var text=$this.options.temp.text();$this.options.temp.html("");$this.options.temp.append("<input type='text' maxlength=50 value='"+text+"' />");$this.options.temp.children("input").mouseleave(function(){$this.options.temp.html($("input[type='text']").val());$this.options.temp.children("input").remove();$this.options.isSave=false})},'pmSave':function(t){$this.convertPoint();if(!$this.options.url){alert("请先配置提交url");return}var data=$this.options.dic.Values();var arrDate=data.concat();arrDate.sort(function(a,b){var _style=a.style;var arr=_style.split(";");var _left=arr[0].substring(0,arr[0].length-1).split(":")[1];var _top=arr[1].substring(0,arr[1].length-1).split(":")[1];var style=b.style;arr=style.split(";");var left=arr[0].substring(0,arr[0].length-1).split(":")[1];var top=arr[1].substring(0,arr[1].length-1).split(":")[1];if(_left==left){return $this.floatSub(parseFloat(_top),parseFloat(top))}return $this.floatSub(parseFloat(_left),parseFloat(left))});$this.options.submitJson.data=arrDate;$.ajax({type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:$this.options.url,data:JSON.stringify($this.options.submitJson),success:function(result){alert(result.message);$this.options.isSave=true},error:function(result){alert("保存失败")}})},'pmRefresh':function(t){$this.refresh()}},onShowMenu:function(e,menu){$this.options.temp=$(e.target);$this.options.point={x:e.offsetX,y:e.offsetY};return menu}});$this.$element.mousedown(function(e){if(e.which!=3){$('div#jqContextMenu').hide()}});$this.options.instance.bind("connection",function(conn,originalEvent){var nodeDiv=$("#"+conn.connection.sourceId);var sourceId=nodeDiv.attr("id");var targetId=conn.connection.targetId;if(conn.connection.sourceId==conn.connection.targetId){$this.options.instance.detach(conn);$this.options.instance.deleteEndpoint(conn.sourceEndpoint,true);$this.options.instance.deleteEndpoint(conn.targetEndpoint,true);return false}$.each($this.options.instance.getEndpoints(conn.source),function(i,el){if(conn.connection!=el.connections[0]&&(el.connections[0].targetId==conn.targetId||(el.connections[0].sourceId==conn.targetId&&el.connections[0].targetId==conn.sourceId))){$this.options.instance.detach(conn);return false}});var pId=nodeDiv.attr("pId");var process=null;var node;if(!pId){node=$this.options.dic.TryGetValue(sourceId);process=node.process}else{var pNode=$this.options.dic.TryGetValue(pId);var subNode=pNode.subNode;for(var i=0;i<subNode.length;i++){if(sourceId==subNode[i].id){node=subNode[i];process=node.process;break}}}var processName;var temp=true;for(var i=0;i<process.length;i++){if(targetId==process[i].id){processName=process[i].name;temp=false;break}}if(processName){conn.connection.getOverlay("label").setLabel(processName)}else{conn.connection.getOverlay("label").hide()}if(temp){node.process.push({"id":targetId,"name":""})}});if($this.options.isEdit){$this.options.instance.bind("dblclick",function(conn,originalEvent){var nodeDiv=$("#"+conn.sourceId);var sourceId=nodeDiv.attr("id");var targetId=conn.targetId;var pId=nodeDiv.attr("pId");var node;if(!pId){node=$this.options.dic.TryGetValue(sourceId)}else{var pNode=$this.options.dic.TryGetValue(pId);var subNode=pNode.subNode;for(var i=0;i<subNode.length;i++){if(sourceId==subNode[i].id){node=subNode[i];break}}}var process=node.process;for(var i=0;i<process.length;i++){if(process[i].id==targetId){process.splice(i,1);break}}$this.options.instance.detach(conn);$this.options.isSave=false})}$this.initData();if($this.options.isEdit){$this.$element.selectable({filter:"div.w"})}if($this.options.wayOfDisplay==2){}if(!$this.options.isEdit){$("div.tooltip").tooltip()}},laout:function(isRefresh){if(!$this.options.minHeight){$this.options.minHeight=document.documentElement.clientHeight}if(!$this.options.minWidth||document.documentElement.clientWidth>$this.options.minWidth){$this.options.minWidth=document.documentElement.clientWidth}if(!isRefresh){$this.initScrollHeight($this.options.minHeight)}if($this.options.wayOfDisplay==1){var laout=layoutDirectedGraph.layout($this.options.dic,$this.options.scrollHeight,{rankSep:$this.options.rankSep,nodeSep:$this.options.nodeSep,edgeSep:$this.options.edgeSep,rankDir:$this.options.rankDir});if(!isRefresh){if(laout.height>$this.options.minHeight){$this.initScrollHeight(laout.height)}if(laout.width>$this.options.minWidth){$this.initScrollWidth(laout.width)}else{$this.initScrollWidth($this.options.minWidth)}}}},initScrollHeight:function(height){$this.$element.css("height",height);$this.options.scrollHeight=height;},initScrollWidth:function(width){$this.$element.css("width",width);$this.options.scrollWidth=width;},getColor:function(){var colors=["#FFC500","#1d953f ","#FF8E46","#f15a22","#008ED6","#8E468E","#2AB6FF"];if($this.options.colorIndex>=colors.length){$this.options.colorIndex=$this.options.colorIndex%colors.length}return colors[$this.options.colorIndex++]},initData:function(){$this.initNode();$this.drawing();$this.initProcess()},initNode:function(){var values=$this.options.dic.Values();for(var i=0;i<values.length;i++){$this.createNode(values[i])}},initProcess:function(){var values=$this.options.dic.Values();for(var i=0;i<values.length;i++){if(values[i].type=="merge"&&values[i].isShow==0){var subNode=values[i].subNode;for(var j=0;j<subNode.length;j++){var process=subNode[j].process;for(var k=0;k<process.length;k++){if($("#"+process[k].id)[0]){$this.options.instance.connect({source:subNode[j].id,target:process[k].id})}}}}else{for(var l=0;l<values[i].process.length;l++){if($("#"+values[i].process[l].id)[0]){$this.options.instance.connect({source:values[i].id,target:values[i].process[l].id})}}}}},revalidate:function(){var nodes=jsPlumb.getSelector("."+$this.$element.attr("id")+" .w");for(var i=0;i<nodes.length;i++){$this.options.instance.revalidate(nodes[i])}},drawing:function(nodes){if(!nodes){nodes=jsPlumb.getSelector("."+$this.$element.attr("id")+" .w");if($this.options.isEdit){$this.options.instance.draggable(nodes)}}$this.options.instance.batch(function(){$this.options.instance.makeSource(nodes,{filter:".ep",anchor:["Continuous",{faces:["right","left"]}],connector:[$this.options.connector,{curviness:20,cornerRadius:10}],connectorStyle:{strokeStyle:"#5c96bc",lineWidth:2,outlineColor:"transparent",outlineWidth:4},maxConnections:5,onMaxConnections:function(info,e){alert("Maximum connections ("+info.maxConnections+") reached")}});$this.options.instance.makeTarget(nodes,{dropOptions:{hoverClass:"dragHover"},anchor:["Continuous",{faces:["right","left"]}],allowLoopback:true})})},createNode:function(nodeJson){var classStr="";if(nodeJson.type=="merge"){if(nodeJson.isShow==0){var subNode=nodeJson.subNode;for(var i=0;i<subNode.length;i++){$this.createNode(subNode[i])}return}classStr="w"}else{classStr="w circle"}var status=nodeJson.status;var tooltip="";if($this.options.isEdit){status=""}else{if(nodeJson.type!="merge"&&nodeJson.id.indexOf("sid-")!=0){status=""}else if(nodeJson.type=="begin"){if(nodeJson.beginTime){classStr+=" tooltip";tooltip="<div class='tooltip_description' style='display:none'><ul>";tooltip+="<br>";tooltip+="<li><span>开始时间：</span>"+nodeJson.beginTime+"</li>";tooltip+="<br>";tooltip+="</ul></div>"}}else if(nodeJson.type=="end"){if(nodeJson.endTime){classStr+=" tooltip";tooltip="<div class='tooltip_description' style='display:none'><ul>";tooltip+="<li><span>结束时间：</span>"+nodeJson.endTime+"</li>";tooltip+="</ul></div>"}}else{classStr+=" tooltip";tooltip="<div class='tooltip_description' style='display:none'><ul>";tooltip+="<li><span>执行人：</span>"+(nodeJson.executePeople?nodeJson.executePeople:"")+"</li>"+"<li><span>预计用时：</span>"+nodeJson.duration+"</li>";if(status==1||status==2||status==3){tooltip+="<li><span>实际用时：</span>"+nodeJson.actualAfterDuration+"</li>";if(nodeJson.overtime!=0){tooltip+="<li><span>超时时间：</span>"+nodeJson.overtime+"</li>"}tooltip+="<li><span>开始时间：</span>"+nodeJson.beginTime+"</li>";tooltip+="<li><span>结束时间：</span>"+nodeJson.endTime+"</li>";if(status==1){tooltip+="<li><span>完成状态：</span>全部完成</li>"}else if(status==2){tooltip+="<li><span>完成状态：</span>部分完成</li>"}else{tooltip+="<li><span>完成状态：</span>跳过</li>"}tooltip+="<li><span>完成情况：</span>"+nodeJson.message+"</li>";status="after"}else if(status==4){tooltip+="<li><span>已经用时：</span>"+nodeJson.actualAfterDuration+"</li>";if(nodeJson.overtime!=0){tooltip+="<li><span>超时时间：</span>"+nodeJson.overtime+"</li>"}tooltip+="<li><span>开始时间：</span>"+nodeJson.beginTime+"</li>";status="executing"}else{status="before"}tooltip+="</ul></div>";if(nodeJson.type=="merge"){classStr="w";tooltip=""}}}var div="<div id='"+nodeJson.id+"' class='"+classStr+"' style='"+nodeJson.style+"' nodeType='"+(nodeJson.type?nodeJson.type:"")+"' pId='"+(nodeJson.pId?nodeJson.pId:"")+"'>"+"<span>"+nodeJson.name+"</span>"+"<div class='ep' id='status"+nodeJson.id+"'></div>"+tooltip+"</div>";var nodeDiv=$(div);if(nodeJson.pId){nodeDiv.css("border-color",$this.options.dic.TryGetValue(nodeJson.pId).color)}else if(nodeJson.type=="merge"){nodeDiv.css("border-color",nodeJson.color)}nodeDiv.children("div.ep").addClass(status);if($this.options.isEdit||(nodeJson.type=="merge"||nodeJson.pId)){nodeDiv.contextMenu('processMenu',{shadow:false,bindings:{'pmCreate':$this.pmCreate,'pmDelete':$this.deleteNode,'pmMerge':function(t){var left=$this.options.currentNode.css("left");var top=$this.options.currentNode.css("top");$this.mergeNode(left,top)},'pmCancel':function(t){$this.cancelNode($this.options.currentNode)},'pmUnfold':function(t){$this.unfoldNode($this.options.currentNode)},'pmShrink':function(t){$this.shrinkNode($this.options.currentNode)},'pmModify':function(t){var text=nodeDiv.text();nodeDiv.children("span").html("");nodeDiv.append("<input type='text' maxlength=50 value='"+text+"' />");nodeDiv.children("input").mouseleave(function(){var value=$("input[type='text']").val();nodeDiv.children("span").html(value);nodeDiv.children("input").remove();$this.options.instance.revalidate(nodeDiv);var id=nodeDiv.attr("id");var pId=nodeDiv.attr("pId");if(!pId){var node=$this.options.dic.TryGetValue(id);node.name=value}else{var target=$this.options.dic.TryGetValue(pId);var subNode=target.subNode;for(var i=0;i<subNode.length;i++){if(id==subNode[i].id){subNode[i].name=value;break}}}$this.options.isSave=false});$this.options.instance.revalidate(nodeDiv)}},onShowMenu:function(e,menu){$this.options.point={x:$this.options.scrollWidth/2,y:$this.options.crollHeight/2};$this.options.currentNode=$(e.currentTarget);var id=$this.options.currentNode.attr("pId");if($(".ui-selected").length>1){$('#pmDelete, #pmShrink, #pmUnfold, #pmModify, #pmUnfold, #pmCancel',menu).remove()}else{if($this.options.currentNode.attr("pId")){$('#pmMerge, #pmUnfold, #pmCancel',menu).remove()}else if($this.options.currentNode.attr("nodetype")=="merge"){$('#pmDelete, #pmMerge, #pmShrink',menu).remove()}else if($this.options.currentNode.attr("id").indexOf("sid-")==0){$('#pmDelete,#pmMerge, #pmUnfold, #pmShrink, #pmCancel',menu).remove()}else{$('#pmMerge, #pmUnfold, #pmShrink, #pmCancel',menu).remove()}}return menu}})}$this.$element.append(nodeDiv);return nodeDiv},deleteNode:function(t){var node=$(t);var nodeType=node.attr("nodeType");if(nodeType=="begin"){alert("流程开始节点不能删除！");return}else if(nodeType=="end"){alert("流程结束节点不能删除！");return}var id=node.attr("id");var pId=node.attr("pId");if(!pId){$this.options.dic.Remove(id)}else{var target=$this.options.dic.TryGetValue(pId);var subNode=target.subNode;for(var i=0;i<subNode.length;i++){if(id==subNode[i].id){subNode.splice(i,1);break}}if(subNode.length==1){var nodeJson=subNode[0];nodeJson.pId="";$this.options.dic.Add(nodeJson.id,nodeJson);$this.options.dic.Remove(target.id)}}$this.removeProcess(id);$this.refresh();$this.options.isSave=false},mergeNode:function(left,top){var nodes=$(".ui-selected");for(var i=0;i<nodes.length;i++){var id=$(nodes[i]).attr("id");var nodeJson=$this.options.dic.TryGetValue(id);if(!nodeJson||nodeJson.type=="merge"){alert("不能与已经合并过的节点进行第二次合并！");return}else if(nodeJson.type=="begin"){alert("开始节点不能进行合并！");return}else if(nodeJson.type=="end"){alert("结束节点不能进行合并！");return}}var arr=[];for(var i=0;i<nodes.length;i++){var id=$(nodes[i]).attr("id");var nodeJson=$this.options.dic.TryGetValue(id);var process=nodeJson.process;for(var j=0;j<process.length;j++){arr.push([nodeJson.id,process[j].id])}}var mergeNodeId=new Date().getTime();$this.setBackProcess(nodes,mergeNodeId);var process=$this.getProcess(nodes);if(!$this.validationMergeNode(nodes,process)){alert("选中的节点不能进行合并！");return}var mergeNodeJson={"id":mergeNodeId+"","pId":"","name":"合并节点","process":process,"type":"merge","isShow":1,"style":"left: "+left+";top: "+top+";","subNode":[],"color":$this.getColor()};for(var i=0;i<nodes.length;i++){var id=$(nodes[i]).attr("id");var nodeJson=$this.options.dic.TryGetValue(id);nodeJson.pId=mergeNodeId;mergeNodeJson.subNode.push(nodeJson);$this.options.dic.Remove(id)}$this.options.dic.Add(mergeNodeId,mergeNodeJson);$this.refresh();$this.options.isSave=false},validationMergeNode:function(nodes,mProcess){if(mProcess.length==1){return true}var idArr=[];var temp=true;for(var i=0;i<nodes.length;i++){var nodeJson=$this.options.dic.TryGetValue($(nodes[i]).attr("id"));if(nodeJson.process.length>1){temp=false}idArr.push($(nodes[i]).attr("id"))}if(temp){return false}for(var i=0;i<mProcess.length;i++){temp=$this.isNext(idArr,$this.options.dic.TryGetValue(mProcess[i].id).process);if(temp){return false}}return true},isNext:function(idArr,process){for(var i=0;i<process.length;i++){if(idArr.indexOf(process[i].id)!=-1){return true}else{var nodeJson=$this.options.dic.TryGetValue(process[i].id);return $this.isNext(idArr,nodeJson.process)}}return false},validBackProcess:function(){var temp=false;var values=$this.options.dic.Values();for(var i=0;i<values.length;i++){temp=false;if(values[i].type=="begin"){continue}for(var j=0;j<values.length;j++){var process=values[j].process;for(var k=0;k<process.length;k++){if(values[i].id==process[k].id){temp=true;break}}if(temp){break}}if(!temp){console.log(values[i]);return false}}return true},getProcess:function(nodes){var idArr=[];var processArr=new Dictionary();for(var i=0;i<nodes.length;i++){idArr.push($(nodes[i]).attr("id"))}for(var i=0;i<nodes.length;i++){var id=$(nodes[i]).attr("id");var nodeJson=$this.options.dic.TryGetValue(id);var process=nodeJson.process;for(var j=0;j<process.length;j++){if(idArr.indexOf(process[j].id)==-1){if(!processArr.ContainsKey(process[j].id)){processArr.Add(process[j].id,process[j])}}}}return processArr.Values()},setBackProcess:function(nodes,nextId){var idArr=[];for(var i=0;i<nodes.length;i++){idArr.push($(nodes[i]).attr("id"))}var values=$this.options.dic.Values();for(var i=0;i<values.length;i++){console.log(values[i].id);if(idArr.indexOf(values[i].id)!=-1){continue}var process=values[i].process;for(var j=0;j<process.length;j++){if(idArr.indexOf(process[j].id)!=-1){process.push({"id":nextId+"","name":""});break}}if(values[i].type=="merge"){var subNode=values[i].subNode;for(var j=0;j<subNode.length;j++){var subProcess=subNode[j].process;for(var k=0;k<subProcess.length;k++){if(idArr.indexOf(subProcess[k].id)!=-1){subProcess.push({"id":nextId+"","name":""});break}}}}}},removeProcess:function(id){var values=$this.options.dic.Values();for(var i=0;i<values.length;i++){var process=values[i].process;for(var j=0;j<process.length;j++){if(process[j].id==id){process.splice(j,1);j--}}if(values[i].type=="merge"){var subNode=values[i].subNode;for(var j=0;j<subNode.length;j++){var subProcess=subNode[j].process;for(var k=0;k<subProcess.length;k++){if(subProcess[k].id==id){subProcess.splice(k,1);k--}}}}}},cancelNode:function(node){var id=node.attr("id");var nodeJson=$this.options.dic.TryGetValue(id);var subNode=nodeJson.subNode;for(var i=0;i<subNode.length;i++){subNode[i].pId="";$this.options.dic.Add(subNode[i].id,subNode[i])}$this.options.dic.Remove(id);$this.removeProcess(id);$this.refresh();$this.options.isSave=false},shrinkNode:function(node){var pId=node.attr("pId");var nodeJson=$this.options.dic.TryGetValue(pId);nodeJson.isShow=1;$this.refresh();$this.options.isSave=false},unfoldNode:function(node){var id=node.attr("id");var nodeJson=$this.options.dic.TryGetValue(id);nodeJson.isShow=0;$this.refresh();$this.options.isSave=false},refresh:function(flowData){$this.options.colorIndex=0;$(".jquery-gdakram-tooltip").remove();if(flowData){$this.options.dic.Clear();for(var i=0;i<flowData.length;i++){if($this.options.showMergeNode==1){flowData[i].isShow=1}else if($this.options.showMergeNode==2){flowData[i].isShow=0}if(flowData[i].type=="merge"){flowData[i].color=$this.getColor()}$this.options.dic.Add(flowData[i].id,flowData[i])}}$this.laout(true);$this.removeAll();$this.initData();if(!$this.options.isEdit){$("div.tooltip").tooltip()}},removeAll:function(){$this.removeAllNode();$this.removeAllConnections()},removeAllNode:function(){$("."+$this.$element.attr("id")+" .w").remove()},removeAllConnections:function(){$this.options.instance.deleteEveryEndpoint();var connections=$this.options.instance.getConnections();for(var i=0;i<connections.length;i++){$this.options.instance.detach(connections[i])}},deleteConnectionByNode:function(node){var connections=$this.options.instance.getConnections();for(var i=0;i<connections.length;i++){var source=connections[i].source;var target=connections[i].target;if(!!source&&source.id==node.attr("id")){$this.options.instance.detach(connections[i])}else if(!!target&&target.id==node.attr("id")){$this.options.instance.detach(connections[i])}}},pmCreate:function(t){var id=new Date().getTime();var nodeJson={"id":id+"","pId":"","name":"新建节点","process":[],"type":"","status":"","isShow":1,"style":"left: "+$this.options.point.x+"px;top: "+$this.options.point.y+"px;"};var node=$this.createNode(nodeJson);$this.options.instance.draggable(node);$this.drawing(node);$this.options.dic.Add(id,nodeJson);$this.options.isSave=false},convertPoint:function(){var values=$this.options.dic.Values();for(var i=0;i<values.length;i++){if($("#"+values[i].id)[0]){var left=parseFloat($("#"+values[i].id).css("left"));var top=parseFloat($("#"+values[i].id).css("top"));values[i].style="left:"+$this.forDight(left/$this.options.scrollWidth*100,4)+"%;top:"+$this.forDight(top/$this.options.scrollHeight*100,4)+"%;"}if(values[i].type=="merge"){var subNode=values[i].subNode;for(var j=0;j<subNode.length;j++){if($("#"+subNode[j].id)[0]){var left=parseFloat($("#"+subNode[j].id).css("left"));var top=parseFloat($("#"+subNode[j].id).css("top"));subNode[j].style="left:"+$this.forDight(left/$this.options.scrollWidth*100,4)+"%;top:"+$this.forDight(top/$this.options.scrollHeight*100,4)+"%;"}}}}},getBeginProcess:function(arr,id){if(!id){id=arr[0][1]}var proc=null;for(var i=0;i<arr.length;i++){if(id==arr[i][1]){proc=$this.getBeginProcess(arr,arr[i][0]);if(proc){return proc}else{return arr[i]}}}return proc},getBackNodeId:function(id){var values=$this.options.dic.Values();for(var i=0;i<values.length;i++){var process=values[i].process;for(var j=0;j<process.length;j++){if(process[j].id==id){return values[i].id}}}return null},getProcessEndId:function(idArr,process,subIdArr){for(var i=0;i<process.length;i++){if($this.isSelect(process[i].id)){subIdArr.push(process[i].id);var nodeJson=$this.options.dic.TryGetValue(process[i].id);$this.getProcessEndId(idArr,nodeJson.process,subIdArr)}else{idArr.push(process[i].id);}}},isSelect:function(id){var nodes=$(".ui-selected");for(var i=0;i<nodes.length;i++){if(id==$(nodes[i]).attr("id")){return true}}return false},addBeginNodeData:function(arr){var idArr=[];for(var i=0;i<arr.length;i++){idArr.push(arr[i][0])}var values=$this.options.dic.Values();for(var i=0;i<values.length;i++){if(idArr.indexOf(values[i].id)!=-1){continue}var process=values[i].process;if(process.length<2){continue}for(var j=0;j<process.length;j++){if(idArr.indexOf(process[j].id)!=-1){for(var k=0;k<process.length;k++){if(idArr.indexOf(process[k].id)!=-1){arr.unshift([values[i].id,process[k].id])}}return}}}},mergeNodeData:function(arr){if($this.options.dataIndex==arr.length){return}var temp=false;for(var i=0;i<arr.length;i++){if(arr.length==1){return}if(arr[$this.options.dataIndex][1]==arr[i][0]){arr[$this.options.dataIndex][1]=arr[i][1];arr.splice(i,1);temp=true;i--}}if(temp){$this.options.dataIndex=0}else{$this.options.dataIndex++}$this.mergeNodeData(arr)},floatSub:function(arg1,arg2){var r1,r2,m,n;try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}m=Math.pow(10,Math.max(r1,r2));n=(r1>=r2)?r1:r2;return((arg1*m-arg2*m)/m).toFixed(n)},forDight:function(Dight,How){Dight=Math.round(Dight*Math.pow(10,How))/Math.pow(10,How);return Dight},isSave:function(){return $this.options.isSave},appendMenu:function(){var processMenu="<div id='processMenu' style='display:none;'>"+"<ul>"+"<li id='pmCreate'><i class='icon-plus'></i> <span class='_label'>新建节点</span></li>"+"<li id='pmModify'><i class='icon-edit'></i> <span class='_label'>修改名称</span></li>"+"<li id='pmShrink'><i class='icon-resize-small'></i> <span class='_label'>收缩节点</span></li>"+"<li id='pmUnfold'><i class='icon-resize-full'></i> <span class='_label'>展开节点</span></li>"+"<li id='pmMerge'><i class='icon-trash'></i> <span class='_label'>合并节点</span></li>"+"<li id='pmCancel'><i class='icon-repeat'></i> <span class='_label'>取消合并</span></li>"+"<li id='pmDelete'><i class='icon-trash'></i> <span class='_label'>删除节点</span></li>"+"</ul>"+"</div>";if(!$this.options.isEdit){processMenu="<div id='processMenu' style='display:none;'>"+"</div>"}else{viewPprocessMenu="<div id='viewPprocessMenu' style='display:none;'>"+"<ul>"+"<li id='pmCreate'><i class='icon-plus'></i> <span class='_label'>新建节点</span></li>"+"<li id='pmSave'><i class='icon-ok'></i> <span class='_label'>保存设计</span></li>"+"<li id='pmRefresh'><i class='icon-refresh'></i> <span class='_label'>刷新视图</span></li>"+"</ul>"+"</div>";$(document.body).append(viewPprocessMenu)}$(document.body).append(processMenu)},getValues:function(){return $this.options.dic.Values()},updateStatus:function(processId,status){var scolor="";if(status==1||status==2||status==3){scolor="#7fb80e"}else if(status==4){scolor="#ffd400"}else{scolor="#77787b"}$('#status'+processId).css({'background-color':scolor})},fullscreen:function(minWidth,minHeight){$this.options.minHeight=minHeight;$this.laout()}};$.fn.escFlowChart=function(options){var flowChart=new EscFlowChart(this,options);flowChart.appendMenu();flowChart.init();return flowChart}})();